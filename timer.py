import asyncio
import time
from steps import format_duration

user_state = {}
tasks = {}
step_completion_shown = set()

async def run_timer(uid, seconds, msg, bot):
    start = time.monotonic()
    bar_states = [
        "‚òÄÔ∏èüåëüåëüåëüåëüåëüåëüåëüåëüåë", "‚òÄÔ∏è‚òÄÔ∏èüåëüåëüåëüåëüåëüåëüåëüåë", "‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏èüåëüåëüåëüåëüåëüåëüåë",
        "‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏èüåëüåëüåëüåëüåëüåë", "‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏èüåëüåëüåëüåëüåë", "‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏èüåëüåëüåëüåë",
        "‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏èüåëüåëüåë", "‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏èüåëüåë",
        "‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏èüåë", "‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è"
    ]
    last_state = ""
    while True:
        elapsed = time.monotonic() - start
        remaining = max(0, int(seconds - elapsed))
        percent_done = min(elapsed / seconds, 1.0)
        bar_index = min(int(percent_done * 10), 9)

        bar = bar_states[bar_index]
        minutes = remaining // 60
        seconds_remain = remaining % 60
        time_label = f"{minutes} –º–∏–Ω {seconds_remain} —Å–µ–∫" if minutes > 0 else f"{seconds_remain} —Å–µ–∫"
        text = f"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: {time_label}\n{bar}"

        if text != last_state:
            try:
                await bot.edit_message_text(text=msg.text.split("\n")[0] + "\n" + text, chat_id=uid, message_id=msg.message_id)
            except:
                pass
            last_state = text

        
    if uid in user_state:
        from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
        from keyboards import steps_keyboard

        step = user_state[uid]["step"]
        if step <= 2:
            back_button = ReplyKeyboardMarkup(resize_keyboard=True)
            back_button.add(KeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –Ω–∞ —à–∞–≥ 1 (–µ—Å–ª–∏ –±—ã–ª –ø–µ—Ä–µ—Ä—ã–≤)"))
            back_button.add(KeyboardButton("üìã –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥–∞–º"))
            await bot.send_message(uid, "–®–∞–≥ –∑–∞–≤–µ—Ä—à—ë–Ω ‚òÄÔ∏è
–ú–æ–∂–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.", reply_markup=back_button)
        else:
            await bot.send_message(uid, "–®–∞–≥ –∑–∞–≤–µ—Ä—à—ë–Ω ‚òÄÔ∏è
–ú–æ–∂–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ–∑–∂–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.", reply_markup=steps_keyboard)
        step_completion_shown.add(uid)

